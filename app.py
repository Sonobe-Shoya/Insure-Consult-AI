import streamlit as st
import google.generativeai as genai

# --- 1. ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(
    page_title="æ—¥æ–°ç«ç½ãƒ»çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆAI",
    page_icon="ğŸ›¡ï¸",
    layout="wide"
)

# --- 2. APIã‚­ãƒ¼ã®è¨­å®š ---
# Streamlit Cloudã®Secretsã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚€
try:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
except Exception:
    st.error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Secretsè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ï¼ˆ1.5 Flashã‚’ä½¿ç”¨ï¼‰
model = genai.GenerativeModel('gemini-1.5-flash')

# --- 3. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šè²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  ---
st.sidebar.title("ğŸ¢ è²¡å‹™ãƒ‡ãƒ¼ã‚¿å…¥åŠ›")
st.sidebar.markdown("ä¼æ¥­ã®æ±ºç®—æ›¸æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

# åŸºæœ¬æƒ…å ±
company_name = st.sidebar.text_input("ä¼æ¥­å", value="æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«å·¥æ¥­")
industry = st.sidebar.selectbox("æ¥­ç¨®", ["è£½é€ æ¥­", "å»ºè¨­æ¥­", "é‹è¼¸æ¥­", "å°å£²ãƒ»å¸å£²æ¥­", "ã‚µãƒ¼ãƒ“ã‚¹æ¥­", "ãã®ä»–"])

# PLï¼ˆæç›Šè¨ˆç®—æ›¸ï¼‰ãƒ‡ãƒ¼ã‚¿
st.sidebar.subheader("æç›Šè¨ˆç®—æ›¸ (P/L)")
revenue = st.sidebar.number_input("å£²ä¸Šé«˜ (ä¸‡å††)", value=10000, step=100)
prev_revenue = st.sidebar.number_input("å‰æœŸå£²ä¸Šé«˜ (ä¸‡å††)", value=9500, step=100)
operating_profit = st.sidebar.number_input("å–¶æ¥­åˆ©ç›Š (ä¸‡å††)", value=500, step=10)
net_income = st.sidebar.number_input("å½“æœŸç´”åˆ©ç›Š (ä¸‡å††)", value=300, step=10)

# BSï¼ˆè²¸å€Ÿå¯¾ç…§è¡¨ï¼‰ãƒ‡ãƒ¼ã‚¿
st.sidebar.subheader("è²¸å€Ÿå¯¾ç…§è¡¨ (B/S)")
current_assets = st.sidebar.number_input("æµå‹•è³‡ç”£ (ä¸‡å††)", value=4000, step=100)
current_liabilities = st.sidebar.number_input("æµå‹•è² å‚µ (ä¸‡å††)", value=3500, step=100)
total_assets = st.sidebar.number_input("ç·è³‡ç”£ (ä¸‡å††)", value=8000, step=100)
total_equity = st.sidebar.number_input("è‡ªå·±è³‡æœ¬ (ä¸‡å††)", value=3000, step=100)


# --- 4. ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼šåˆ†æå®Ÿè¡Œ ---

st.title("ğŸ›¡ï¸ æ—¥æ–°ç«ç½ çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°AI")
st.markdown("""
ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€æ—¥æ–°ç«ç½ã®ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°è¦–ç‚¹ã‹ã‚‰
**ã€Œåç›Šæ€§ãƒ»å®‰å…¨æ€§ãƒ»æˆé•·æ€§ã€**ã‚’åˆ†æã—ã€æœ€é©ãªä¿é™ºå•†å“ã‚’ææ¡ˆã—ã¾ã™ã€‚
""")

# ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰AIåˆ†æã‚’é–‹å§‹
if st.button("çµŒå–¶åˆ†æã‚’é–‹å§‹ã™ã‚‹", type="primary"):
    
    with st.spinner("AIã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆãŒè²¡å‹™è«¸è¡¨ã‚’åˆ†æä¸­..."):
        try:
            # --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆï¼ˆJavaScriptã‹ã‚‰Pythonã¸ç§»æ¤ã—ãŸéƒ¨åˆ†ï¼‰ ---
            # ã“ã“ã§Pythonã®å¤‰æ•°ã‚’åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™
            prompt = f"""
            ã‚ãªãŸã¯æ—¥æ–°ç«ç½æµ·ä¸Šä¿é™ºã®çµŒå–¶ã‚³ãƒ³ã‚µãƒ«å‹å–¶æ¥­æ‹…å½“ã§ã™ã€‚
            ä»¥ä¸‹ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ­ã®è¦–ç‚¹ã§åˆ†æã—ã€ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

            ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘
            æ¥­ç¨®: {industry}
            ä¼æ¥­å: {company_name}
            å£²ä¸Š: {revenue}ä¸‡å†† (å‰æœŸ: {prev_revenue}ä¸‡å††)
            å–¶æ¥­åˆ©ç›Š: {operating_profit}ä¸‡å††, ç´”åˆ©ç›Š: {net_income}ä¸‡å††
            æµå‹•è³‡ç”£: {current_assets}ä¸‡å††, æµå‹•è² å‚µ: {current_liabilities}ä¸‡å††
            ç·è³‡ç”£: {total_assets}ä¸‡å††, è‡ªå·±è³‡æœ¬: {total_equity}ä¸‡å††

            ã€ã‚¿ã‚¹ã‚¯ã€‘
            ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è¦‹ã‚„ã™ãå‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

            1. **çµŒå–¶ã‚¹ã‚³ã‚¢è¨ºæ–­**
               - åç›Šæ€§ã€å®‰å…¨æ€§ã€æˆé•·æ€§ã‚’ãã‚Œãã‚Œ100ç‚¹æº€ç‚¹ã§è©•ä¾¡ã—ã€ãã®æ ¹æ‹ ã‚’æ•°å­—ã‚’ç”¨ã„ã¦ç°¡æ½”ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚

            2. **ã“ã®ä¼æ¥­ã®çµŒå–¶èª²é¡Œ (3é¸)**
               - è²¡å‹™æ•°å€¤ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ã€ã“ã®ä¼æ¥­ãŒæŠ±ãˆã‚‹å…·ä½“çš„ãªãƒªã‚¹ã‚¯ã‚„èª²é¡Œã‚’3ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚

            3. **æ—¥æ–°ç«ç½å•†å“ã®ææ¡ˆ**
               - æ—¥æ–°ç«ç½ã®ä¸»è¦å•†å“ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€åŠ´ç½ã‚ã‚“ã—ã‚“ä¿é™ºã€ãƒ“ã‚¸ã‚µãƒã€ã‚µã‚¤ãƒãƒ¼ä¿é™ºç­‰ï¼‰ã‹ã‚‰ã€
                 ä¸Šè¨˜ã®èª²é¡Œè§£æ±ºã«æœ€é©ãªã‚‚ã®ã‚’3ã¤é¸ã³ã€ä»¥ä¸‹ã®å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
                 - **å•†å“å**:
                 - **ææ¡ˆç†ç”±**: (è²¡å‹™èª²é¡Œã¨ãƒªãƒ³ã‚¯ã•ã›ã¦)
                 - **ã‚»ãƒ¼ãƒ«ã‚¹ãƒˆãƒ¼ã‚¯**: (çµŒå–¶è€…ã«åˆºã•ã‚‹ä¸€è¨€)
            """

            # AIã«é€ä¿¡
            response = model.generate_content(prompt)
            
            # çµæœã‚’è¡¨ç¤º
            st.success("åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼")
            st.markdown("---")
            st.markdown(response.text)
            
        except Exception as e:
            st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
